- name: Install the latest version of 8Knot
  hosts: [ospo]
  tasks:
    - name: Ensure git is installed
      apt:
        name: git
        state: present
        update_cache: true
      become: true
    - name: Ensure docker is installed
      apt:
        pkg:
          - docker
          - docker.io
          - docker-compose
        state: present
        update_cache: true
      become: true
    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    - name: Reset ssh connection to allow user changes to affect ansible user
      ansible.builtin.meta:
        reset_connection

    - name: Prepare location for 8Knot sources
      ansible.builtin.file:
        path: /opt/git/8Knot
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
      become: true

    - name: Clone the 8Knot repository
      git:
        repo: https://github.com/oss-aspen/8Knot
        dest: /opt/git/8Knot
        clone: yes
        update: yes
        single_branch: yes
        version: main
    
    - name: Patch the 8Knot repository
      ansible.posix.patch:
        src: ../patches/8knot/proxyfix.patch
        remote_src: false
        dest: /opt/git/8Knot/8Knot/app.py
    

    


    
    # - name: Install required system packages
    #   # from: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-20-04
    #   apt:
    #     pkg:
    #       - apt-transport-https
    #       - ca-certificates
    #       - curl
    #       - software-properties-common
    #       - python3-pip
    #       - virtualenv
    #       - python3-setuptools
    #     state: latest
    #     update_cache: true
    
