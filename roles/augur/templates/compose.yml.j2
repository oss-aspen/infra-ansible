#SPDX-License-Identifier: MIT

x-postgres-common:
  &postgres-common
  image: postgres:16
  user: postgres
  restart: unless-stopped
  stop_grace_period: 1800s
  shm_size: 1g
  healthcheck:
    test: 'pg_isready -U augur --dbname=postgres'
    interval: 10s
    timeout: 5s
    retries: 5

services:
  augur-db:
    <<: *postgres-common
    environment:
      POSTGRES_DB: ${AUGUR_DB}
      POSTGRES_USER: ${AUGUR_DB_USER}
      POSTGRES_PASSWORD: ${AUGUR_DB_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256\nhost replication all 0.0.0.0/0 md5"
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
      command: |
        postgres
        -c wal_level=replica
        -c hot_standby=on
        -c max_wal_senders=10
        -c max_replication_slots=10
        -c hot_standby_feedback=on
    volumes:
      - /opt/augur/config/00_init.sql:/docker-entrypoint-initdb.d/00_init.sql
      - /opt/augur/postgresql/data:/var/lib/postgresql/data
      - /opt/facade/dumps/:/dumps
    ports:
      - 5432:5432 # expose port for replication
    networks:
      - augur

  redis:
    image: redis:alpine
    restart: unless-stopped
    networks:
      - augur

  augur-keyman:
    image: augur-keyman
    restart: unless-stopped
    user: 3456:3456  # Run as an arbitrary non-root user
    environment:
      REDIS_CONN_STRING: redis://redis:6379
    depends_on:
      - redis
    networks:
      - augur

  rabbitmq:
    image: augur-rabbitmq:latest
    restart: unless-stopped
    environment:
      RABBIT_MQ_DEFAULT_USER: ${AUGUR_RABBITMQ_USERNAME}
      RABBIT_MQ_DEFAULT_PASSWORD: ${AUGUR_RABBITMQ_PASSWORD}
      RABBIT_MQ_DEFAULT_VHOST: ${AUGUR_RABBITMQ_VHOST}
    networks:
      - augur

  augur:
    #image: augur-new:latest
    image: augur:v0.90.0
    #image: augur:v0.89.3_fix
    volumes:
      - /opt/facade/clones:/augur/facade
      - /opt/facade/logs:/logs
    restart: unless-stopped
    #command:
    #  [ "sleep", "3600" ]
    ports:
      - 5000:5000
    extra_hosts:
      - "host.docker.internal:host-gateway" #Be able to ping services on the local machine
    environment:
      AUGUR_DB: postgresql+psycopg2://${AUGUR_DB_USER:-augur}:${AUGUR_DB_PASSWORD:-augur}@augur-db:5432/augur
      AUGUR_DB_SCHEMA_BUILD: 1
      AUGUR_DOCKER_DEPLOY: 1
      AUGUR_FLAGS: ${AUGUR_FLAGS}
      AUGUR_GITHUB_USERNAME: ${AUGUR_GITHUB_USERNAME}
      AUGUR_GITHUB_API_KEY: ${AUGUR_GITHUB_API_KEY}
      AUGUR_GITLAB_USERNAME: ${AUGUR_GITLAB_USERNAME}
      AUGUR_GITLAB_API_KEY: ${AUGUR_GITLAB_API_KEY}
      REDIS_CONN_STRING: redis://redis:6379
      RABBITMQ_CONN_STRING: amqp://${AUGUR_RABBITMQ_USERNAME:-augur}:${AUGUR_RABBITMQ_PASSWORD:-password123}@rabbitmq:5672/${AUGUR_RABBITMQ_VHOST:-augur_vhost}
    networks:
      - augur
    depends_on:
      - augur-db
      - redis
      - rabbitmq

  flower:
    #image: augur-new:latest
    image: augur:v0.90.0
    #image: augur:v0.89.3_fix
    restart: unless-stopped
    command:
#      [ "celery", "-A", "augur.tasks.init.celery_app.celery_app", "flower" ]
# Test this for the Flower crash
      [ "celery", "-A", "augur.tasks.init.celery_app.celery_app", "flower", "--max-tasks=1000000" ]
    environment:
      AUGUR_DB: postgresql+psycopg2://${AUGUR_DB_USER:-augur}:${AUGUR_DB_PASSWORD:-augur}@augur-db:5432/augur
      REDIS_CONN_STRING: redis://redis:6379
      RABBITMQ_CONN_STRING: amqp://${AUGUR_RABBITMQ_USERNAME:-augur}:${AUGUR_RABBITMQ_PASSWORD:-password123}@rabbitmq:5672/${AUGUR_RABBITMQ_VHOST:-augur_vhost}
    ports:
      - 5555:5555
    networks:
      - augur
    depends_on:
      - augur
      - augur-db
      - redis
      - rabbitmq
  
networks:
  augur:
